"use strict";(()=>{var o=jQuery;var x=e=>{e.preventDefault();let t=o(e.currentTarget),r=t.siblings(".spinner"),n=t.siblings(".alert");r.css({visibility:"visible"}),o.ajax({url:window.ajaxurl,data:{action:"check_"+t.siblings("[type=text]").attr("name"),key:t.siblings("[type=text]").val()},success:function(i){console.log(typeof i.error),r.css({visibility:"hidden"});let c=i.error?'<div class="notice notice-error">'+i.message+"</div>":'<div class="notice notice-success">'+i.message+"</div>";if(n.html(c),!i.error&&typeof i.extra<"u")switch(i.extra){case"pull_for_result_auth_by_organisation_number":break;default:c='<div class="notice notice-error">Unexpected payload.</div>',n.html(c)}},dataType:"json"})};function u(e){return typeof window.fortnox_l10n<"u"&&typeof window.fortnox_l10n[e]<"u"?window.fortnox_l10n[e]:e}var y=(e,t)=>{t<0&&(t=0),t>100&&(t=100),e.find(o(".fill")).css("width",t+"%"),t=Math.ceil(t),e.find(o(".text")).html(t+" %")};var h={fortnox_sync_orders_date_range:async e=>{let t=o("input#fortnox_order_date_range_btn"),r=o("#fortnox_order_sync_range_progress_description");o(".date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0});function n(){setTimeout(()=>{o("#order_sync_date_to").removeAttr("disabled"),o("#order_sync_date_from").removeAttr("disabled"),t.removeClass("button-secondary"),t.addClass("button-primary"),t.val(u("Start")),t.on("click",f)},1e3)}function i(){o("button.fortnox_modal_close").off(),o(document).on("click","button.fortnox_modal_close",()=>{console.log("close"),o(".fortnox_sync_orders_date_range_shade").hide(),o(".fortnox_sync_orders_date_range_modal").hide(),e.css({visibility:"hidden"}),o(".fortnox_order_sync_range_setup").show()})}i(),o(".fortnox_sync_orders_date_range_shade").show(),o(".fortnox_sync_orders_date_range_modal").show(),o("button.fortnox_modal_close").off(),o("span.order_sync_start").off();async function c(s){return o.ajax({url:window.ajaxurl,data:{action:"fortnox_action",fortnox_action:"sync_order",order_id:s},type:"POST",dataType:"json"})}async function l(s){o("button.fortnox_modal_close").off(),o("#order_sync_date_to").attr("disabled",""),o("#order_sync_date_from").attr("disabled",""),o(".fortnox-order-sync-range-progress").show(),o(".fortnox_order_sync_range_setup").hide();let d=0;for(let a=0;a<s.length;a++)await c(s[a]).then(function(){d=(a+1)/s.length*100,y(o(".fortnox_order_sync_range_progress_bar"),d)})}let f=async()=>{console.log("orderSyncStartMethod");let s=!1,d=o("#fortnox_sync_on_status").val();if(r.html(""),o("#order_sync_date_to").val()==""||o("#order_sync_date_from").val()==""){let a=u("Please set ranges")+" ("+d+"): "+s;r.html("<br>"+a),n();return}o(".fortnox_sync_orders_date_range_modal .wc-backbone-modal-main").addClass("hide-footer"),await o.ajax({url:window.ajaxurl,data:{action:"fortnox_bulk_action",bulk:"fortnox_sync_orders_date_range",from_date:o("#order_sync_date_from").val(),to_date:o("#order_sync_date_to").val(),status:o("#fortnox_sync_on_status").val()},success:a=>{a.error?(s=!0,r.append("<br><b>"+u("Error")+":</b><br>"+a.message),o(".fortnox-order-sync-range-progress").show(),o(".fortnox_sync_orders_date_range_modal .wc-backbone-modal-main").removeClass("hide-footer")):l(a.order_ids)},error:(a,p,_)=>{s=!0;let Q=u("Error occurred querying backend with status")+" ("+p+"): "+_;r.html("<br>"+Q),o(".fortnox_sync_orders_date_range_modal .wc-backbone-modal-main").removeClass("hide-footer")},dataType:"json"})};n()},fortnox_sync_products:async e=>{let t=o("input#fortnox_sync_products_btn"),r=o("#fortnox_product_sync_progress_description");function n(){setTimeout(()=>{t.removeClass("button-secondary"),t.addClass("button-primary"),t.val(u("Start")),t.off(),t.on("click",f)},1e3)}function i(){o("button.fortnox_modal_close").off(),console.log(o("button.fortnox_modal_close").length),o(document).on("click","button.fortnox_modal_close",s=>{console.log("close"),o(".fortnox_sync_products_shade").hide(),o(".fortnox_sync_products_modal").hide(),e.css({visibility:"hidden"}),o(".fortnox_sync_products_setup").show()})}i(),o(".fortnox_sync_products_shade").show(),o(".fortnox_sync_products_modal").show(),o("button.fortnox_modal_close").off(),o("span.order_sync_start").off();async function c(s){return r.html(u("Processing Product ID: ")+s),o.ajax({url:window.ajaxurl,data:{action:"fortnox_action",fortnox_action:"sync_product",product_id:s},type:"POST",dataType:"json",success:function(d){}})}async function l(s){o("button.fortnox_modal_close").off(),o(".fortnox-product-sync-progress").show(),o(".fortnox_sync_products_setup").hide();let d=0;for(let a=0;a<s.length;a++)await c(s[a]).then(function(){d=(a+1)/s.length*100,y(o(".fortnox_sync_products_progress_bar"),d)});r.html(u("Process done"))}let f=async()=>{let s=!1;t.off(),r.html(u("Process started")),o(".fortnox_sync_products_modal .wc-backbone-modal-main").addClass("hide-footer"),await o.ajax({url:window.ajaxurl,data:{action:"fortnox_bulk_action",bulk:"fortnox_sync_products"},success:d=>{d.error?(s=!0,r.append("<br><b>"+u("Error")+":</b><br>"+d.message),o(".fortnox_sync_products_modal .wc-backbone-modal-main").removeClass("hide-footer")):l(d.product_ids)},error:(d,a,p)=>{s=!0;let _=u("Error occurred querying backend with status")+" ("+a+"): "+p;return r.html("<br>"+_),o(".fortnox_sync_products_modal .wc-backbone-modal-main").removeClass("hide-footer"),alert(_)},dataType:"json"})};n()}};var b=e=>{e.preventDefault();let t=o(e.currentTarget),r=t.siblings(".spinner");if(!t.data("fortnox-bulk-action"))return console.warn("No bulk action specified.");if(r.css({visibility:"visible"}),t.data("modal")){let n=t.data("fortnox-bulk-action");h[n](r);return}o.ajax({url:window.ajaxurl,data:{action:"fortnox_bulk_action",bulk:t.data("fortnox-bulk-action")},success:function(n){if(r.css({visibility:"hidden"}),typeof n.message<"u")return alert(n.message)},dataType:"json"})};var w=e=>{o(e.currentTarget).parents(".is-dismissible").first().hide()};var k=()=>{let e={attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200};o(".tips, .help_tip, .woocommerce-help-tip").tipTip(e),o(".parent-tips").each(function(){o(this).closest("a, th").attr("data-tip",o(this).data("tip")).tipTip(e).css("cursor","help")})};var v=e=>{let t=o(".form-table");o(e.currentTarget).is(":checked")?t.find("tr").eq(2).show():t.find("tr").eq(2).hide()};var C=(e,t)=>`<div id="fortnox-message" class="updated notice notice-${e} is-dismissible"><p>${t}</p><button type="button" class="notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button></div>`;var m=(e,t)=>{e.preventDefault();let r=o(e.currentTarget),n=r.siblings(".fortnox-spinner"),i=r.siblings(".wetail-fortnox-status"),c={action:"fortnox_action",fortnox_action:t};t==="sync_product"?c.product_id=r.data("product-id"):c.order_id=r.data("order-id"),n.css({visibility:"visible"}),i.hide(),o("#fortnox-message").remove(),o.ajax({url:window.ajaxurl,data:c,type:"POST",dataType:"json",success:function(l){l.error||i.removeClass("wetail-icon-cross").addClass("wetail-icon-check"),n.css({visibility:"hidden"}),i.show();let f=o(C(l.error?"error":"success",l.message));o("#wpbody .wrap h1").after(f);let s=o("#fortnox-message");t!=="send_invoice"&&s.show(),t!=="sync_product"&&o(".sendInvoiceToCustomer[data-order-id="+r.data("order-id")+"]").removeClass("wetail-hidden"),o("html, body").animate({scrollTop:s.offset().top-100})}})};var S=e=>{e.preventDefault();let r=o(e.currentTarget).data("section"),n=new URLSearchParams(window.location.search),i=window.location.origin+window.location.pathname;n.set("section",r),sessionStorage.setItem("fortnox-params",n.toString()),window.history.pushState({},"",i+"?"+n.toString()),window.location.reload()};var T=e=>{e.preventDefault();let t=o(".license-status"),r=o(".license-status").data("logged-out-text");o.ajax(window.ajaxurl,{method:"GET",data:{action:"fortnox_logout"}}).done(n=>{if(n=typeof n=="string"?JSON.parse(n):n,n.error){console.error("Fortnox logged out error",n.error),t.after(`<p class="logged-out-error">${n.error.toString()}</p>`);return}n.message&&(t.fadeOut(200),o(".logged-out-error").fadeOut(200),setTimeout(function(){t.removeClass("active").addClass("not-active"),t.find(o("span")).text(r),t.fadeIn(300)},300),console.log("Fortnox logged success",n.message))})};var P=()=>{o(document.body).on("click",".button.fortnox-check-connection",x).on("click",".fortnox-bulk-action",b).on("click",".syncOrderToFortnox",e=>{m(e,"sync_order")}).on("click",".syncProductToFortnox",e=>{m(e,"sync_product")}).on("click",".notice-dismiss",w).on("click",".sendInvoiceToCustomer",e=>{m(e,"send_invoice")}).on("click",".fortnox-admin-settings .subsubsub > li > a",S).on("click",".fortnox-admin-settings .fortnox-logged-out",T).on("init_tooltips",k).on("change",'input[type="checkbox"][name="fortnox_has_warehouse_module"]',v)};var j=()=>{o(document.body).trigger("init_tooltips")};var $=()=>{new URLSearchParams(window.location.search).get("tab")=="order"&&window.order_settings.fortnox_has_warehouse_module!=1&&o(".form-table").find("tr").eq(2).hide()};var O=()=>{o('.settings_page_fortnox form[action="options.php"] select').each(function(){let t=o(this),r=t.find(o("option"));t.select2({width:"250px",minimumResultsForSearch:r.length>=10?10:-1})})};var J=()=>{let e=sessionStorage.getItem("fortnox-params"),t=new URLSearchParams(window.location.search),r=window.location.origin+window.location.pathname,n=t.get("tab"),i=null,c="",l=t.get("section");if(e&&(i=new URLSearchParams(e),c=i.get("tab")??""),i&&n===c&&(window.history.pushState({},"",r+"?"+e),l=i.get("section"),sessionStorage.removeItem("fortnox-params")),!l){o(".fortnox-section").eq(0).fadeIn(200),o(".subsubsub li").eq(0).find(o("a")).addClass("current");return}let f=o(`a[data-section="${l}"]`),s=o(`div[data-section-id="${l}"]`);f.addClass("current"),s.fadeIn(200)};var g=()=>{$(),P(),j(),O(),J()};document.readyState==="complete"?g():window.addEventListener("load",function(){g()});})();
